<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
<meta charset="UTF-8" />
<title>enja - Part 2</title>
<link rel="profile" href="http://gmpg.org/xfn/11" />
<link rel="stylesheet" type="text/css" media="all" href="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/themes/twentyten-child/style.css" />
<link rel="pingback" href="../../xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="enj &raquo; Feed" href="../../enjaorg" />
<link rel="alternate" type="application/rss+xml" title="enj &raquo; Comments Feed" href="../../comments/feed/index.html" />
				
	<script type="text/javascript">//<![CDATA[
	// Google Analytics for WordPress by Yoast v4.2.3 | http://yoast.com/wordpress/google-analytics/
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount','UA-16564388-1']);
	_gaq.push(['_trackPageview']);
	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
	//]]></script>
<link rel='stylesheet' id='tfg_style-css'  href='../../wp-content/plugins/twitter-facebook-google-plusone-share/tfg_style.css%3Fver=3.3.2.css' type='text/css' media='all' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../xmlrpc.php%3Frsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://enja.org/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.3.2" />
<link rel='shortlink' href='http://wp.me/gWjI' />

<!-- All in One SEO Pack 1.6.14.2 by Michael Torbert of Semper Fi Web Design[82,140] -->
<link rel="canonical" href="index.html" />
<!-- /all in one seo pack -->
<meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.3" />
</head>

<body class="home blog paged paged-2">
<div id="wrapper" class="hfeed">
	<div id="header">
		<div id="masthead">
			<div id="branding" role="banner">
								<h1 id="site-title">
					<span>
						<a href="../../index.html" title="enj" rel="home">enj</a>
					</span>
				</h1>
				<div id="site-description">casin&#039; the joint since &#039;85</div>

										<img src="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2010/07/cropped-turtle_nom1.jpg" width="940" height="198" alt="" />
								</div><!-- #branding -->

			<div id="access" role="navigation">
			  				<div class="skip-link screen-reader-text"><a href="index.html#content" title="Skip to content">Skip to content</a></div>
								<div class="menu-header"><ul id="menu-navigation" class="menu"><li id="menu-item-319" class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item menu-item-home menu-item-319"><a href="../../index.html" >Home</a></li>
<li id="menu-item-318" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-318"><a href="../../about/index.html" >About</a></li>
<li id="menu-item-694" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-694"><a href="../../d3/index.html" >d3</a></li>
<li id="menu-item-316" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-316"><a href="../../blender/index.html" >Blender</a></li>
<li id="menu-item-315" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-315"><a href="../../opencl/index.html" >OpenCL</a></li>
<li id="menu-item-317" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-317"><a href="../../side-projects/index.html" >Side Projects</a></li>
</ul></div>			</div><!-- #access -->
		</div><!-- #masthead -->
	</div><!-- #header -->

	<div id="main">

		<div id="container">
			<div id="content" role="main">

			
	<div id="nav-above" class="navigation">
		<div class="nav-previous"><a href="../3/index.html" ><span class="meta-nav">&larr;</span> Older posts</a></div>
		<div class="nav-next"><a href="../../index.html" >Newer posts <span class="meta-nav">&rarr;</span></a></div>
	</div><!-- #nav-above -->




			<div id="post-592" class="post-592 post type-post status-publish format-standard hentry category-code category-life category-processingjs category-tech">
			<h2 class="entry-title"><a href="../../2011/06/27/silenced/index.html" title="Permalink to Silenced" rel="bookmark">Silenced</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on</span> <a href="../../2011/06/27/silenced/index.html" title="9:45 pm" rel="bookmark"><span class="entry-date">June 27, 2011</span></a> <span class="meta-sep">by</span> <span class="author vcard"><a class="url fn n" href="../../author/admin/index.html" title="View all posts by enj">enj</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p>This past weekend I attended <a href="http://datainsightsf.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://datainsightsf.com']);">Data Insight</a> and hacked alongside a great group of people. Our <a href="http://datainsightresults.wordpress.com/2011/06/26/team-11/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://datainsightresults.wordpress.com']);">team</a> had a lot of fun and learned a lot by tackling a tough issue, child abuse. We used the statistics for 2002 from <a href="http://www.infochimps.com/datasets/child-abuse-and-neglect-cases-substantiated-and" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.infochimps.com']);">infochimps</a> to visualize reported child abuse cases in the US. We wanted to do more than just show proportions by category and with some creative influence from <a href="http://datainsightsf.com/jury/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://datainsightsf.com']);">excellent speakers</a> we came up with this:<br />
<script type="text/javascript" src="../../diblog/processing.js"></script><br />
<script src="../../diblog/Tween.lib"></script><br />
<script type="text/javascript" src="../../diblog/init.js"></script><br />
<canvas datasrc="http://enja.org/diblog/setup.pde http://enja.org/diblog/data.pde http://enja.org/diblog/ui.pde http://enja.org/diblog/kid.pde"><br />
</canvas><br />
Check the original full width <a href="../../datainsight/ca.html" >standalone version</a></p>
<p>
You can mouse over the circles in the top left to view each category of abuse and see the warning signs. We hope that interacting with the visualization allows people to spend a little more time exposed to something we would otherwise rather not think about. Awareness is a large part of prevention, and we hope this can help.
</p>
<p>Additionally we&#8217;d like to point out the lack of good data in this area. The reports available offer no insight into categories which would be useful to explore, such as breakdown by age, gender, race, family size or any other metric. There seem to be proprietary data sets which require actual mail to obtain. I particularly hope that events like data insight help show the importance and usefulness of good data. Check out the winning teams for some <a href="http://datainsightsf.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://datainsightsf.com']);">awesome examples</a></p>
<p>I also want to shout out to my team: <a href="http://cargocollective.com/kristenchan" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://cargocollective.com']);">Kristen</a>, <a href="http://jacobesparza.posterous.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://jacobesparza.posterous.com']);">Jacob</a> and Wei. We met on Friday and became friends by Sunday. We had a lot of fun in a short amount of time!</p>
<p> As always I&#8217;ve gotta get technical, so I want to say a few things about how this was made. It&#8217;s all <a href="http://processingjs.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://processingjs.com']);">processing.js<a> with a nice Tween library from <a href="http://quasipartikel.at/tween/">Quasipartikel</a>. I implemented a 2D flocking particle system based on my colleague <a href="http://mymese.blogspot.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://mymese.blogspot.com']);">Myrna&#8217;s</a> work. The &#8220;kids&#8221; each represent 1% of child abuse cases, so each category has however many kid particles as percent of cases. They react to the mouse with avoidance or goal oriented behavior depending on a variable set per category. They also have <a href="http://www.red3d.com/cwr/boids/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.red3d.com']);">flocking rules</a> which vary slightly by category to get for example more aggressive behavior or more spread out. All the code is on <a href="https://github.com/enjalot/datainsightsf" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">github</a> so you can check it out. Keep in mind it was hacked together in one weekend!</p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
									<span class="cat-links">
						<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="../../category/code/index.html" title="View all posts in code" rel="category tag">code</a>, <a href="../../category/life/index.html" title="View all posts in life" rel="category tag">life</a>, <a href="../../category/processingjs/index.html" title="View all posts in processingjs" rel="category tag">processingjs</a>, <a href="../../category/tech/index.html" title="View all posts in tech" rel="category tag">tech</a>					</span>
					<span class="meta-sep">|</span>
												<span class="comments-link"><a href="../../2011/06/27/silenced/index.html#comments" title="Comment on Silenced">1 Comment</a></span>
							</div><!-- .entry-utility -->
		</div><!-- #post-## -->

		
	


			<div id="post-584" class="post-584 post type-post status-publish format-standard hentry category-code category-life category-opencl">
			<h2 class="entry-title"><a href="../../2011/06/13/lbl-summer-research-report-1/index.html" title="Permalink to LBL Summer Research: Report 1" rel="bookmark">LBL Summer Research: Report 1</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on</span> <a href="../../2011/06/13/lbl-summer-research-report-1/index.html" title="8:12 pm" rel="bookmark"><span class="entry-date">June 13, 2011</span></a> <span class="meta-sep">by</span> <span class="author vcard"><a class="url fn n" href="../../author/admin/index.html" title="View all posts by enj">enj</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p>Hello world! I&#8217;m excited to be writing to you from the beautiful Bay area in California, specifically the Lawrence Berkeley National Laboratory at the top of the hill in Berkeley.</p>
<p><a href="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/06/bayfromhill.jpg" ><img class="aligncenter size-full wp-image-587" title="bayfromhill" src="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/06/bayfromhill.jpg" alt="view of the Bay from Berkeley Lab" width="600" height="450" /></a></p>
<p>This summer I&#8217;ll be working with <a href="http://vis.lbl.gov/~hrchilds/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://vis.lbl.gov']);">Hank Childs</a> and the visualization team of the Computational Research Division on, excuse my nerdiness, some pretty cool stuff. The underlying goal of my project is to study the use of GPUs for accelerating distributed computations on super computers. The specific topic of my research will be particle advection for <a href="http://en.wikipedia.org/wiki/Ftle" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://en.wikipedia.org']);">FTLE</a> calculations. In English you could think of this topic as trying to find out how fast things separate in a flow, you can imagine dropping fish food in a turbulent stream and seeing where the flakes get separated the fastest. Like my <a href="../../2010/12/16/particles-in-bge-fluids-in-real-time-with-opencl/index.html" >Master&#8217;s research</a> I will be using OpenCL and moving around a lot of particles, only for this project I will be moving a lot more particles on much bigger computers. Luckily, many of the efforts I make here will improve both my understanding and some of my underlying code for my <a href="../../2011/03/31/particles-in-bge-improved-code-collisions-and-hose/index.html" >Blender project</a>. Already I have reused several pieces from the RTPS library and I plan on releasing my OpenCL wrappers as an improved standalone library very soon (just need to clean up some and add a couple little examples).</p>
<p>Here is an unscientific but interesting picture of my first successful result. After that I will be describing my project and progress in painful (it hurts so good) computational science detail.</p>
<p><a href="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/06/ftle1.png" ><img class="aligncenter size-full wp-image-588" title="ftle" src="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/06/ftle1.png" alt="first result of FTLE computations in OpenCL" width="600" height="564" /></a></p>
<p>My research problem for the summer is investigating particle advection on the GPU in a distributed memory setting.</p>
<p>The key issues to explore are the costs and benefits of using a GPU in this environment. Since GPUs can greatly accelerate computation but suffer from increased memory latency we want to find out exactly how using the GPU changes the equations governing communication and performance using an interesting visualization problem as the guinea pig. The FTLE computations themselves are already complete and were handed to me by some smart coworkers in my first week. The interesting thing about FTLE is that it requires seed particles to be advected by a velocity field, a common problem when visualizing data from Computational Fluid Dynamics simulations.</p>
<p>My approach to the project is to first implement some code which can accomplish this in three phases and then study the performance in comparison with an existing CPU implementation by a coworker. The first phase is relatively complete, as evidenced by the picture above, which is to implement the FTLE calculations in OpenCL on one GPU. The second phase I am beginning this week is to setup a communications infrastructure using some routines from <a href="https://wci.llnl.gov/codes/visit/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://wci.llnl.gov']);">Visit</a> (which are based on MPI) for transferring particles between nodes and sending them to and from the GPU. The third phase will be combining the two so that calculations are performed and the results are communicated as necessary.</p>
<p>I&#8217;m not sure how long it will take me to do phase 2, as I have relatively little experience with MPI type coding. My distributed data experience is limited to website load balancing and I&#8217;m not yet sure if there are more similarities or differences.</p>
<p>I am encouraged by my leaders here to write a weekly report. Some of these, such as this first one will be posted on my blog, others may remain internal until the time is right. In any case I&#8217;m excited to share as much as possible about what I&#8217;m learning and I look forward to pushing OpenCL to new frontiers!</p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
									<span class="cat-links">
						<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="../../category/code/index.html" title="View all posts in code" rel="category tag">code</a>, <a href="../../category/life/index.html" title="View all posts in life" rel="category tag">life</a>, <a href="../../category/opencl/index.html" title="View all posts in opencl" rel="category tag">opencl</a>					</span>
					<span class="meta-sep">|</span>
												<span class="comments-link"><a href="../../2011/06/13/lbl-summer-research-report-1/index.html#comments" title="Comment on LBL Summer Research: Report 1">3 Comments</a></span>
							</div><!-- .entry-utility -->
		</div><!-- #post-## -->

		
	


			<div id="post-558" class="post-558 post type-post status-publish format-standard hentry category-misc">
			<h2 class="entry-title"><a href="../../2011/05/01/can-you-see-the-force/index.html" title="Permalink to Can you see the force?" rel="bookmark">Can you see the force?</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on</span> <a href="../../2011/05/01/can-you-see-the-force/index.html" title="8:32 pm" rel="bookmark"><span class="entry-date">May 1, 2011</span></a> <span class="meta-sep">by</span> <span class="author vcard"><a class="url fn n" href="../../author/admin/index.html" title="View all posts by enj">enj</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p>I&#8217;ve been working on my Master&#8217;s Thesis lately and getting a headache from all the formal writing. So I just want to blog some informal shit real quick. Here are a bunch of screenshots I took playing with my 2D PyOpenCL implementation of SPH (It&#8217;s pretty much the exact same OpenCL code thats in my <a href="../../2011/03/31/particles-in-bge-improved-code-collisions-and-hose/index.html" >Blender Game Engine project</a>). I&#8217;m playing with OpenGL 3.3 Geometry shaders to make the little red arrows. The arrows represent the force exerted on each particle from the SPH calculations. You can see the waves form as particles are repelled by high density areas and attracted to low density areas. The bigger the force the more red the particles get as well, with no force they are just blue.<br />
I built in the ability to add particles with the mouse by clicking, which you can do while the simulation is paused. So I drew my name and then unpaused it:<br />
<a href="http://imgur.com/5u9Ap" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://imgur.com']);" title="Hosted by imgur.com"><img src="http://i.imgur.com/5u9Apl.jpg" title="Hosted by imgur.com" /></a><br />
<a href="http://i.imgur.com/c8Lbal" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://i.imgur.com']);" title="Hosted by imgur.com" /><img src="http://i.imgur.com/c8Lbal.jpg" title="Hosted by imgur.com" /></a><br />
<a href="http://i.imgur.com/Dqlxdl" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://i.imgur.com']);" title="Hosted by imgur.com" /><img src="http://i.imgur.com/Dqlxdl.jpg" title="Hosted by imgur.com" /></a></p>
<p>Here are some fun looking screens I got by creating some crazy density profiles and letting it go: (click through to imgur to see the fullsize screenshots in 2560&#215;1600 resolution)<br />
<a href="http://i.imgur.com/KDv1tl" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://i.imgur.com']);" title="Hosted by imgur.com" /><img src="http://i.imgur.com/KDv1tl.jpg" title="Hosted by imgur.com" /></a><br />
<a href="http://i.imgur.com/3TtLKl.jpg" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://i.imgur.com']);" title="Hosted by imgur.com" /><img src="http://i.imgur.com/3TtLKl.jpg" title="Hosted by imgur.com" /></a><br />
<a href="http://i.imgur.com/mp2F5l" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://i.imgur.com']);" title="Hosted by imgur.com" /><img src="http://i.imgur.com/mp2F5l.jpg" title="Hosted by imgur.com" /></a></p>
<p>So quick shout out to <a href="http://mikepan.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://mikepan.com']);">Mike Pan</a> for his geometry shader <a href="http://blog.mikepan.com/some-more-shader/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://blog.mikepan.com']);">post</a> that got me started. Using Geometry shaders in PyOpenGL wasn&#8217;t the most straightforward thing, but I ended up piecing things together from <a href="http://www.readmespot.com/question/o/3936368/geometry-shader-doesn-t-do-anything-when-fed-gl_points" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.readmespot.com']);">various</a> <a href="http://programminglinuxgames.blogspot.com/2011/03/pyopengl-geometry-shaders-python-and.html" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://programminglinuxgames.blogspot.com']);">sources</a>.<br />
<strong>Technical note:</strong> For some reason I had to specify</p>
<pre class="brush: python; title: ; notranslate" title="">
        self.program = glCreateProgram()
        glProgramParameteriARB(self.program, GL_GEOMETRY_INPUT_TYPE_ARB, GL_POINTS)
        glProgramParameteriARB(self.program, GL_GEOMETRY_OUTPUT_TYPE_ARB, GL_POINTS) #not sure why this works
        glProgramParameteriARB(self.program, GL_GEOMETRY_VERTICES_OUT_ARB, 20)
        self.compileProgram( self.program, vshader, fshader, gshader)
</pre>
<p>Even though I&#8217;m doing this in the geometry shader</p>
<pre class="brush: cpp; title: ; notranslate" title="">
            #version 330
            layout(points) in;
            layout(triangle_strip) out;
</pre>
<p>Changing GL_POINTS to anything else gives me cryptic errors. Perhaps some OpenGL veterans wouldn&#8217;t mind explaining this? I should probably go read the spec, maybe when I&#8217;m done writing!<br />
The code is burried deep in one of the 30 branches in my EnjaParticles github repository, its so experimental and mixed in with other crap that I&#8217;m not going to directly link to it. I&#8217;m planning to use this as a research platform for improving SPH since prototyping (OpenCL) in python is much easier so eventually it will get cleaned up and released.</p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
									<span class="cat-links">
						<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="../../category/misc/index.html" title="View all posts in misc" rel="category tag">misc</a>					</span>
					<span class="meta-sep">|</span>
												<span class="comments-link"><span>Comments Off</span></span>
							</div><!-- .entry-utility -->
		</div><!-- #post-## -->

		
	


			<div id="post-542" class="post-542 post type-post status-publish format-standard hentry category-blender category-code category-opencl">
			<h2 class="entry-title"><a href="../../2011/03/31/particles-in-bge-improved-code-collisions-and-hose/index.html" title="Permalink to Particles in BGE: Improved Code, Collisions and Hose" rel="bookmark">Particles in BGE: Improved Code, Collisions and Hose</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on</span> <a href="../../2011/03/31/particles-in-bge-improved-code-collisions-and-hose/index.html" title="5:01 am" rel="bookmark"><span class="entry-date">March 31, 2011</span></a> <span class="meta-sep">by</span> <span class="author vcard"><a class="url fn n" href="../../author/admin/index.html" title="View all posts by enj">enj</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p>Hello world! I&#8217;m back with another video to show you guys what we are cooking up here at <a href="http://www.facebook.com/FSUSciComp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.facebook.com']);">DSC</a>. I&#8217;ve made a lot of internal improvements to the code, but I have a little something to show as far as features too. Check out the video!</p>
<p><iframe src="http://player.vimeo.com/video/21743717" width="640" height="480" frameborder="0"></iframe>
<p><a href="http://vimeo.com/21743717" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://vimeo.com']);">[RTPS] Improved Code, Collisions and Hose</a> from <a href="http://vimeo.com/user4640702" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://vimeo.com']);">Ian Johnson</a> on <a href="http://vimeo.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://vimeo.com']);">Vimeo</a>.</p>
<p>So what have I been up to? Mostly I&#8217;ve been cleaning up the code, fixing some nasty bugs in OpenCL that were causing crashes. They seem to all be squashed for now so I can start focusing on some key things (besides writing my thesis!) such as fixing up the collisions even more. I also want to take the hose object I&#8217;ve got now and make it more interactive so gamers can start spraying things! I&#8217;ve been upgrading the UI and exposing more simulation parameters, but there is plenty more work to be done in that area. I look forward to getting it set up in the Particle Panel when the rendering mode is set to Blender Game.</p>
<p>We&#8217;ve also been working on getting the project built on windows, which <a href="http://andrewfsu.blogspot.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://andrewfsu.blogspot.com']);">Andrew Young</a> has gotten well underway. He&#8217;s got the standalone library compiling and running on windows (even with stereo 3D rendering!) but we still need to link it up to Blender.</p>
<p>I&#8217;m in the process of writing this up for my Master&#8217;s thesis, which will lead to some extensive documentation. I hope that with a proper writeup it will be easier to collaborate with other Blender developers and get my code better integrated. I do want to thank the Blender community and especially the devs in the IRC channel for all the help so far, it really is amazing to learn so much from people all over the world!</p>
<p><a href="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/dsc_fsuseal_small.jpg" ><img class="aligncenter size-full wp-image-545" title="DSC" src="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/dsc_fsuseal_small.jpg" alt="" width="600" height="325" /></a></p>
<p>The DSC model used to contain the fluid particles in this picture was created by <a href="http://www.medborgarplatsen.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.medborgarplatsen.com']);">Martin Lindelöf</a>. Also thanks to <a href="http://dustycloud.org/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://dustycloud.org']);">Chris Webber</a> and <a href="http://tube.freefac.org/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://tube.freefac.org']);">Slikdigit</a> for Blender Python UI inspiration and tutelage. Shout out to <a href="http://mogurijin.wordpress.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://mogurijin.wordpress.com']);">Moguri</a> for all his help!</p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
									<span class="cat-links">
						<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="../../category/blender/index.html" title="View all posts in blender" rel="category tag">blender</a>, <a href="../../category/code/index.html" title="View all posts in code" rel="category tag">code</a>, <a href="../../category/opencl/index.html" title="View all posts in opencl" rel="category tag">opencl</a>					</span>
					<span class="meta-sep">|</span>
												<span class="comments-link"><a href="../../2011/03/31/particles-in-bge-improved-code-collisions-and-hose/index.html#comments" title="Comment on Particles in BGE: Improved Code, Collisions and Hose">16 Comments</a></span>
							</div><!-- .entry-utility -->
		</div><!-- #post-## -->

		
	


			<div id="post-521" class="post-521 post type-post status-publish format-standard hentry category-advcl category-code category-python category-tutorial">
			<h2 class="entry-title"><a href="../../2011/03/30/adventures-in-opencl-part-3-constant-memory-structs/index.html" title="Permalink to Adventures in OpenCL Part 3: Constant Memory Structs" rel="bookmark">Adventures in OpenCL Part 3: Constant Memory Structs</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on</span> <a href="../../2011/03/30/adventures-in-opencl-part-3-constant-memory-structs/index.html" title="4:46 pm" rel="bookmark"><span class="entry-date">March 30, 2011</span></a> <span class="meta-sep">by</span> <span class="author vcard"><a class="url fn n" href="../../author/admin/index.html" title="View all posts by enj">enj</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p>Today we make a brief stop on our journey to examine a technique which has proven useful but not straightforward; passing in a structure as a parameter to an <a href="http://www.khronos.org/registry/cl/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.khronos.org']);">OpenCL</a> kernel as <span class="simple_code">__constant</span> memory. Why would you want to do this? Allow me to spin you <a href="../../category/blender/index.html" >a tale</a> of 8 kernels which share an assortment of around <a href="https://github.com/enjalot/EnjaParticles/blob/rtps/rtps/rtpslib/system/sph/cl_src/cl_structs.h" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">30 parameters</a> many of which are either configurable by the user or can change at runtime based on user input. Throw in the fact that a complex program like this requires plenty of debugging and who knows which parameters will end up at the finish line and which will be left by the wayside. So rather than specify an assortment of variables to pass to each kernel, we define a structure to hold our colorful collection of floats and ints and just throw the whole bundle at each kernel. This is of course convenient for us programmers, at least once structs in OpenCL make some sense to us, and as a bonus it turns out to be a good idea in terms of memory usage as well. So lets get into it!</p>
<h3>Grab the code</h3>
<p>You can follow along in <a href="https://github.com/enjalot/adventures_in_opencl/tree/master/part3" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">C++</a> or <a href="https://github.com/enjalot/adventures_in_opencl/tree/master/python/part3" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">Python</a></p>
<p>This is just a slight adaption of my Part 1 (<a href="../../2010/07/20/adventures-in-opencl-part-1-5-cpp-bindings/index.html" >C++</a>, <a href="../../2011/02/22/adventures-in-pyopencl-part-1-getting-started-with-python/index.html" >Python</a>) tutorial code, so check those out if you need help getting started.</p>
<p>So lets take a look at what we want to achieve in OpenCL:</p>
<pre class="brush: cpp; gutter: true; title: ; notranslate" title="">
typedef struct Params
{
    float A;
    float B;
    int C;
} Params;

__kernel void part3(__global const float *a,
                  __global const float *b,
                  __global float *c,
                  __constant struct Params* test
                  )
{
    int gid = get_global_id(0);
    c[gid] = test-&gt;A * a[gid] + test-&gt;B * b[gid] + test-&gt;C;
}
</pre>
<p>You can see on line 16 that all we are doing here is a simple sum, but multiplying each number by a (float) parameter and adding an (int) parameter. You may already have noticed something weird going on in line 12, why is the Params struct a pointer? Excellent question. Even though we only want one structure, we still need to pass it in as a buffer to appease OpenCL (NOTE: This is a problem we&#8217;ve come across, we&#8217;d love to see sample code which allowed straightforward passing of a struct). So it&#8217;s just going to pass a bunch of binary data to the kernel, and then the kernel will have to structure the data when it gets there. And as far as I can tell the only way to get a buffer into a kernel is by passing it in with the pointer syntax you see on line 12 here.<br />
Passing a struct as a buffer is not much different from passing a regular array in <a href="https://github.com/enjalot/adventures_in_opencl/blob/master/part3/part3.cpp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">C++</a>:</p>
<pre class="brush: cpp; title: ; notranslate" title="">
Params params;
params.A = .5f;
params.B = 10.0f;
params.C = 3;
cl_params = cl::Buffer(context, CL_MEM_READ_ONLY, sizeof(Params), NULL, &amp;err);
err = queue.enqueueWriteBuffer(cl_params, CL_TRUE, 0, sizeof(Params), &amp;params, NULL, &amp;event);
</pre>
<p>In <a href="https://github.com/enjalot/adventures_in_opencl/blob/master/python/part3/part3.py" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">Python</a> (more on the <a href="http://docs.python.org/library/struct.html" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://docs.python.org']);">struct module</a>)</p>
<pre class="brush: python; title: ; notranslate" title="">
params = struct.pack('ffffi', .5, 10., 0., 0., 3)
params_buf = cl.Buffer(ctx, mf.READ_ONLY, len(params))
cl.enqueue_write_buffer(queue, params_buf, params).wait()
</pre>
<p>And that&#8217;s all it takes to have access to our structure in OpenCL!</p>
<p><strong>Update: Please see David Garcias comment below for a correction of this section. A quick experiment showed that it&#8217;s not necessary to have padding in this case. I still find this a confusing issue and it would be nice to see some self-contained example code showing cases where alignment breaks.</strong><br />
<em><br />
So about that <span class="simple_code">float padding[2];</span> in the struct definition. This is because of memory <em>alignment</em> in OpenCL. The best explanation I&#8217;ve seen so far is by <a href="http://forums.amd.com/forum/messageview.cfm?catid=390&amp;threadid=122209&amp;forumid=9 " onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://forums.amd.com']);">AndreasStahl</a> which I will briefly summarize in relation to the struct above.<br />
When interpreting a struct, OpenCL accesses the memory in blocks of 16 bytes, which is the same as 4 floats (each 4 bytes). So in our example if we did not have the padding, we would not be able to access our int because opencl would have interpreted it as the 3rd float out of the first 16bytes. This can get even more complicated if you have an array of structs, because then the size of you&#8217;re struct will need to be a multiple of 16, as explained in the linked forum post.<br />
</em></p>
<p>So lets talk a little bit about <span class="simple_code">__constant</span> memory. On a GPU this memory is read-only, cached and usually around 64kb per multiprocessor (you can query this, for an example look to the CLInfo example in the <a href="http://developer.amd.com/gpu/AMDAPPSDK/Pages/default.aspx" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://developer.amd.com']);">AMD SDK</a> and oclDeviceQuery in the <a href="http://developer.download.nvidia.com/compute/opencl/sdk/website/samples.html" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://developer.download.nvidia.com']);">NVIDIA SDK</a>). It is closer to the processor than <span class="simple_code">__global</span> and much faster to access, while slightly slower than <span class="simple_code">__local</span> memory, so if you are passing in a ton of them you may be eating into the precious few (48) kilobytes you have, so moving them to <span class="simple_code">__constant</span> memory can free up a little space as well.</p>
<p>Additionally, at least on some implementations there seems to be an <del datetime="2011-04-01T21:08:53+00:00">arbitrary</del> limit of 9 constant (non-buffer) parameters, which using a struct will help you avoid. (NOTE: as David points out below, the limit is not arbitrary. It can be queried through clGetDeviceInfo() and CL_DEVICE_MAX_CONSTANT_ARGS)</p>
<p>What about other people&#8217;s approaches? What kind of trouble have you run into with structs? kernel parameters?</p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
									<span class="cat-links">
						<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="../../category/tutorial/advcl/index.html" title="View all posts in advcl" rel="category tag">advcl</a>, <a href="../../category/code/index.html" title="View all posts in code" rel="category tag">code</a>, <a href="../../category/python/index.html" title="View all posts in python" rel="category tag">python</a>, <a href="../../category/tutorial/index.html" title="View all posts in tutorial" rel="category tag">tutorial</a>					</span>
					<span class="meta-sep">|</span>
												<span class="comments-link"><a href="../../2011/03/30/adventures-in-opencl-part-3-constant-memory-structs/index.html#comments" title="Comment on Adventures in OpenCL Part 3: Constant Memory Structs">7 Comments</a></span>
							</div><!-- .entry-utility -->
		</div><!-- #post-## -->

		
	


			<div id="post-493" class="post-493 post type-post status-publish format-standard hentry category-advcl category-code category-opencl category-python category-tutorial">
			<h2 class="entry-title"><a href="../../2011/03/22/adventures-in-pyopencl-part-2-particles-with-pyopengl/index.html" title="Permalink to Adventures in PyOpenCL: Part 2, Particles with PyOpenGL" rel="bookmark">Adventures in PyOpenCL: Part 2, Particles with PyOpenGL</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on</span> <a href="../../2011/03/22/adventures-in-pyopencl-part-2-particles-with-pyopengl/index.html" title="5:23 pm" rel="bookmark"><span class="entry-date">March 22, 2011</span></a> <span class="meta-sep">by</span> <span class="author vcard"><a class="url fn n" href="../../author/admin/index.html" title="View all posts by enj">enj</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p><a href="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/pypart2_small.png" ><img class="alignright size-full wp-image-510" title="20,000 Particles" src="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/pypart2_small.png" alt="20,000 Particles" width="320" height="250" /></a>Today we journey as pythonauts into the world of particle systems and fast 3D graphics, manipulating thousands upon thousands of little dots in mere milliseconds! We accomplish this with two Python modules, PyOpenCL and PyOpenGL. This is a port of my <a href="../../2010/08/27/adventures-in-opencl-part-2-particles-with-opengl/index.html" >C++ OpenCL tutorial</a>, but with much less code and all the splendors of numpy.</p>
<p>What you&#8217;ll need:</p>
<ul>
<li><a href="http://numpy.scipy.org/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://numpy.scipy.org']);">numpy</a> (at least version 1.4)</li>
<li><a href="http://pyopengl.sourceforge.net/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://pyopengl.sourceforge.net']);">PyOpenGL</a></li>
<li><a href="http://mathema.tician.de/software/pyopencl" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://mathema.tician.de']);">PyOpenCL</a>(for now, Mac users will need to <a href="http://wiki.tiker.net/PyOpenCL/Installation/Mac#Optional:_OpenGL_Interop" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://wiki.tiker.net']);">build from git</a>)</li>
<li><a href="https://github.com/enjalot/adventures_in_opencl/tree/pypt2/python/part2" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">the code</a></li>
<li>A graphics card and driver that support <a href="http://www.khronos.org/opencl/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.khronos.org']);">OpenCL</a></li>
</ul>
<h3>Let&#8217;s get started!</h3>
<p>First lets take a look at the files we will be dissecting</p>
<pre>- important files
    main.py
    part2.py
    part2.cl
    initialize.py
- support files
    glutil.py
    vector.py
    timing.py</pre>
<p>You can go ahead and run <span class="simple_code">python main.py</span> to see the code in action.  The way our particle system works is that we have some collection of particles, really just 3D points in space, each with it&#8217;s own lifetime. Every time we loop we want to update the positions of our particles based on some set of rules (e.g. gravity, initial velocity) and decrease their lifetime a little. When the lifetime of a particle reaches 0 we set it back to its original position and reset its lifetime. So we want to structure our code so that we initialize the positions of the particles first, then every frame we update and render them.</p>
<p><a href="https://github.com/enjalot/adventures_in_opencl/blob/pypt2/python/part2/main.py" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">main.py</a> is responsible for setting up the OpenGL environment using PyOpenGL and GLUT, providing mouse and keyboard interaction as well as a run loop for our program. So now we have some 3D space we can look around by clicking and dragging (left and right mouse buttons) or hit &#8216;q&#8217; to quit and &#8216;t&#8217; to print out timing of the update function.</p>
<h3>The Setup</h3>
<p>Once we have our environment we need to setup some particles, for this look in <a href="https://github.com/enjalot/adventures_in_opencl/blob/pypt2/python/part2/initialize.py" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">initialize.py</a>. The first function you will see is <span class="simple_code">function_np</span> which creates several numpy arrays and sets their values using numpy slice operators. If that&#8217;s a little confusing, it may be easier to follow the <span class="simple_code">fountain_loopy</span> function which does the same thing but with a (slower) for loop. Essentially we are randomly placing the particles on a flat donut in the x, y plane. They each start with an initial velocity in the same direction as their position and a random lifetime. We also make an RGBA color array so that each particle can have its own color.</p>
<p>Notice the <span class="simple_code">fountain</span> function at the bottom, which just calls the <span class="simple_code">fountain_np</span> function and creates Vertex Buffer Objects (VBO) out of the numpy arrays. Presumably when you go on to make your own OpenCL/OpenGL code you will start with your own numpy arrays and this is a key point for setting up your memory on the GPU. If you want OpenCL to be able to act on OpenGL memory (without making copies) you will need to prepare VBOs (or render buffer objects with clImage which should be the subject of a later tutorial) before you go to OpenCL. Luckily its dead simple with PyOpenGL</p>
<pre class="brush: python; title: ; notranslate" title="">
    from OpenGL.arrays import vbo
    pos_vbo = vbo.VBO(data=pos, usage=GL_DYNAMIC_DRAW, target=GL_ARRAY_BUFFER)
    pos_vbo.bind()
</pre>
<p>Now lets look in <a href="https://github.com/enjalot/adventures_in_opencl/blob/pypt2/python/part2/main.py" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">main.py</a> to see how the initialize functions are called and the results are passed into OpenCL.</p>
<pre class="brush: python; title: ; notranslate" title="">
     #set up initial conditions
     (pos_vbo, col_vbo, vel) = initialize.fountain(num)
     #create our OpenCL instance
     self.cle = part2.Part2(num, dt)
     self.cle.loadData(pos_vbo, col_vbo, vel)
</pre>
<p>Here num and dt are defined at the top of main.py, which are user parameters for how many particles to make and essentially how much simulation time passes each frame. Now we get to the OpenCL, we&#8217;ve made an instance of a Part2 class. Then we call <span class="simple_code">loadData</span> with the vbos and velocity array.</p>
<h3>Interfacing with OpenCL</h3>
<p>Let&#8217;s take a look at what the constructor and loadData are doing in <a href="https://github.com/enjalot/adventures_in_opencl/blob/pypt2/python/part2/part2.py" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">part2.py</a></p>
<pre class="brush: python; title: ; notranslate" title="">
     self.clinit()
     self.loadProgram(&quot;part2.cl&quot;);
     self.num = num
     self.dt = numpy.float32(dt)
</pre>
<p>Notice how we explicitly &#8220;cast&#8221; dt to a numpy float, this is required to pass variables (non-buffers) to a PyOpenCL kernel.</p>
<p>Now let&#8217;s take a minute to look at what <span class="simple_code">clinit</span> is doing, for it is responsible for setting up our CL Context using the existing GL context.</p>
<pre class="brush: python; title: ; notranslate" title="">
    plats = cl.get_platforms()
    from pyopencl.tools import get_gl_sharing_context_properties
    import sys
    if sys.platform == &quot;darwin&quot;:
        self.ctx = cl.Context(properties=get_gl_sharing_context_properties(),
                             devices=[])
    else:
        self.ctx = cl.Context(properties=[
            (cl.context_properties.PLATFORM, plats[0])]
            + get_gl_sharing_context_properties(), devices=None)

    self.queue = cl.CommandQueue(self.ctx)
</pre>
<p>First we get a list of available OpenCL platforms on the machine and then import a handy function provided by PyOpenCL which abstracts the <a href="http://sa10.idav.ucdavis.edu/docs/sa10-dg-opencl-gl-interop.pdf " onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://sa10.idav.ucdavis.edu']);">messy business[pdf]</a> of setting up the right properties for sharing a GL context. Due to the eccentric whims of Apple (hey, they pretty much came up with OpenCL) the way you create the context on Mac OS X is slightly different, hence the if statement checking for &#8220;darwin&#8221;. After that its back to business as usual by creating a CommandQueue from the context. If you are using PyOpenCL .92 or beta2011 you will need to replace the contents of the <span class="simple_code">clinit</span> function with <a href="https://gist.github.com/885214" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://gist.github.com']);">this code</a>.</p>
<p>So <span class="simple_code">loadProgram</span> is the same as in <a href="../../2011/02/22/adventures-in-pyopencl-part-1-getting-started-with-python/index.html" >Part 1</a> where we simply read in the file to instantiate and build a program object. So lets skip that and get straight into loading the data:</p>
<pre class="brush: python; first-line: 25; gutter: true; title: ; notranslate" title="">
def loadData(self, pos_vbo, col_vbo, vel):
        import pyopencl as cl
        mf = cl.mem_flags

        #... cut out the saving of variables to self ...

        #Setup vertex buffer objects and share them with OpenCL as GLBuffers
        self.pos_vbo.bind()
        self.pos_cl = cl.GLBuffer(self.ctx, mf.READ_WRITE, int(self.pos_vbo.buffers[0]))
        self.col_vbo.bind()
        self.col_cl = cl.GLBuffer(self.ctx, mf.READ_WRITE, int(self.col_vbo.buffers[0]))

        #pure OpenCL arrays
        self.vel_cl = cl.Buffer(self.ctx, mf.READ_ONLY | mf.COPY_HOST_PTR, hostbuf=vel)
        self.pos_gen_cl = cl.Buffer(self.ctx, mf.READ_ONLY | mf.COPY_HOST_PTR, hostbuf=self.pos)
        self.vel_gen_cl = cl.Buffer(self.ctx, mf.READ_ONLY | mf.COPY_HOST_PTR, hostbuf=self.vel)
        self.queue.finish()

        # set up the list of GL objects to share with opencl
        self.gl_objects = [self.pos_cl, self.col_cl]
</pre>
<p>The key here is on line 33 in creating OpenCL buffers from the vbo objects using the <span class="simple_code">cl.GLBuffer</span> class. Notice how we do not pass in the vbo object itself, but the actual integer value of the buffer as it is represented by OpenGL. We create normal OpenCL buffers as we did in Part 1 simply by passing in numpy arrays (♥). The other significant change is defining the <span class="simple_code">gl_objects</span> list which we will use in execute!</p>
<h3>Execute!</h3>
<pre class="brush: python; first-line: 53; gutter: true; title: ; notranslate" title="">
def execute(self, sub_intervals):
        cl.enqueue_acquire_gl_objects(self.queue, self.gl_objects)

        global_size = (self.num,)
        local_size = None

        kernelargs = (self.pos_cl,
                      self.col_cl,
                      self.vel_cl,
                      self.pos_gen_cl,
                      self.vel_gen_cl,
                      self.dt)

        for i in xrange(0, sub_intervals):
            self.program.part2(self.queue, global_size, local_size, *(kernelargs))

        cl.enqueue_release_gl_objects(self.queue, self.gl_objects)
        self.queue.finish()
</pre>
<p>The first thing to point out is that we are acquiring the <span class="simple_code">gl_objects</span> before we pass them in as arguments to the kernel. This makes sure that OpenGL is not using the buffers for anything and allows us to read from and write to them. We are setting our global workgroup size to the length of our arrays, essentially saying that each thread global workitem will be one element of our original array.<br />
We also introduce sub intervals, allowing us to perform a variable number of updates per frame. This means one could make dt smaller, generally making the simulation more accurate but not slow down the desired motion of the particles. For example if you decrease dt from .01 to .001 you will be making the particles move 10 times slower every iteration, so to keep the visual speed the same you would do 10 sub iterations.</p>
<h3>The Kernel</h3>
<p>So after all that setup we are ready to run our kernel, found in <a href="https://github.com/enjalot/adventures_in_opencl/blob/pypt2/python/part2/part2.cl" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">part2.cl</a>.<br />
<script src="https://gist.github.com/882003.js"> </script></p>
<p>This is also the exact same kernel as used in my <a href="../../2010/08/27/adventures-in-opencl-part-2-particles-with-opengl/index.html" >C++ version</a>.</p>
<p>So there you have it, the essentials of interoperating between OpenCL and OpenGL in Python! I didn&#8217;t cover what I did in my utility files but those are subjects of later posts. You should be able to poke around to see whats going on, and as far as rendering I&#8217;m using very basic GL calls for VBOs which there are <a href="http://www.songho.ca/opengl/gl_vbo.html" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.songho.ca']);">other</a> <a href="http://sdickinson.com/wordpress/?p=122" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://sdickinson.com']);">tutorials</a> <a href="http://www.siafoo.net/article/58" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.siafoo.net']);">for</a>.</p>
<p>I&#8217;d like to shout out to Keith Brafford for helping test and refactor this code on Windows as well as the PyOpenCL patch I worked on to get GL interop working on the Mac. Of course this tutorial wouldn&#8217;t be possible without the valiant efforts of <a href="http://mathema.tician.de/software/pyopencl" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://mathema.tician.de']);">Andreas Klöckner</a>!</p>
<p>As a sample of what&#8217;s possible I <a href="https://github.com/enjalot/adventures_in_opencl/tree/master/experiments/wave" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">implemented</a> a solver for the 1D Wave equations as <a href="http://www.cs.sjsu.edu/~rucker/capow/paper/node5.html" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.cs.sjsu.edu']);">described here</a>.</p>
<p><a href="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/wave2.png" ><img class="alignright size-full wp-image-512" title="Wave equation with tracer particles" src="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/wave2.png" alt="" width="638" height="503" /></a></p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
									<span class="cat-links">
						<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="../../category/tutorial/advcl/index.html" title="View all posts in advcl" rel="category tag">advcl</a>, <a href="../../category/code/index.html" title="View all posts in code" rel="category tag">code</a>, <a href="../../category/opencl/index.html" title="View all posts in opencl" rel="category tag">opencl</a>, <a href="../../category/python/index.html" title="View all posts in python" rel="category tag">python</a>, <a href="../../category/tutorial/index.html" title="View all posts in tutorial" rel="category tag">tutorial</a>					</span>
					<span class="meta-sep">|</span>
												<span class="comments-link"><a href="../../2011/03/22/adventures-in-pyopencl-part-2-particles-with-pyopengl/index.html#comments" title="Comment on Adventures in PyOpenCL: Part 2, Particles with PyOpenGL">21 Comments</a></span>
							</div><!-- .entry-utility -->
		</div><!-- #post-## -->

		
	


			<div id="post-482" class="post-482 post type-post status-publish format-standard hentry category-code category-community category-python category-travel">
			<h2 class="entry-title"><a href="../../2011/03/14/pycon-2011/index.html" title="Permalink to pycon 2011" rel="bookmark">pycon 2011</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on</span> <a href="../../2011/03/14/pycon-2011/index.html" title="2:04 am" rel="bookmark"><span class="entry-date">March 14, 2011</span></a> <span class="meta-sep">by</span> <span class="author vcard"><a class="url fn n" href="../../author/admin/index.html" title="View all posts by enj">enj</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<div id="attachment_484" class="wp-caption alignright" style="width: 310px"><a href="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/python_indented_small.jpg" ><img class="size-full wp-image-484" title="Python: Programming the way Guido indented it" src="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/python_indented_small.jpg" alt="" width="300" height="179" /></a><p class="wp-caption-text">sweet shirt from Google</p></div>
<p><a href="http://andrewfsu.blogspot.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://andrewfsu.blogspot.com']);">Andrew</a>, <a href="http://mathnathan.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://mathnathan.com']);">Nathan</a> and I just got back from Atlanta for Pycon 2011 and it was a blast. It was a great mix of learning, hacking, networking and free swag. I have never been picky about free t-shirts before, but there were so many badass shirts that I actually walked past a booth with well designed shirts because I already use AWS and don&#8217;t want to rep any other hosting provider&#8230; Google was giving out cool swag, and I actually won a raffle for a Galaxy Tab which I will be compiling my <a href="../../2011/01/03/rtps-on-my-android/index.html" >RTPS</a> particles to shortly. We accumulated more than just free stuff, there was much knowledge to be gained from the talks and the Birds of a Feather sessions. There were a few really great talks, namely <a href="http://pycon.blip.tv/file/4639616/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://pycon.blip.tv']);">David Beazley</a> on turning his 1979 SuperBoard into a cloud computing platform.  This guy is the epitome of a hacker and at the same time an excellent presenter, he takes you on a twisted journey using beautiful and powerful tools to operate on ancient technology to create a frankenstein monster with the byproduct of his sick experiment being five packages ported to python3. Not only does he explain some awesome technical feats, he does it in a way which makes you feel like you could too, and he gives just enough detail to entice you and not too much to bore. I found that the best talks were those who really love doing what they do, and the excitement shines from them more than the projector. In particular I really liked <a href="http://dustycloud.org/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://dustycloud.org']);">Christopher Webber</a>&#8216;s talk on the Blender Python API bpy as well as Yung-Yu Chen&#8217;s talk on <a href="http://solvcon.net/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://solvcon.net']);">SOLVCON</a>. I do not want to sound overly critical or negative, but I do think it should be mentioned that we were underwhelmed with more than a few presentations. Granted public speaking is not easy, especially when you speak on inevitably complex topics but the quality of many presenters (but not the quality of their content) left something to be desired. Perhaps at a conference about such an elegant language I would hope people would express themselves with more clarity. In any case, there was a huge amount of knowledge encapsulated in the <a href="http://pycon.blip.tv/?sort=custom;view=archive;date=;user=pycon;s=posts;nsfw=dc;page=1" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://pycon.blip.tv']);">talks</a> (not all of them seem to be in this archive).</p>
<p>The Bird&#8217;s of a Feather were something else entirely, I found them all incredibly informative, met some really smart and knowledgable people and exchanged some cool ideas. The Scientific Computing, Visualization and GPU Computing sessions all had around 20+ people discussing various techniques, problems and libraries they experience in several interesting and disparate fields. A bunch of Blendheads got together Saturday night and did some show-and-tell along with lots of great discussions. I was lucky enough to be schooled on bpy and UI coding by none other than <a href="http://tube.freefac.org/team" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://tube.freefac.org']);">slikdigit</a> and <a href="http://dustycloud.org/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://dustycloud.org']);">paroneayea</a> and I&#8217;m inspired to refactor my current efforts to expose much more of my library to Python. It&#8217;s amazing what artists can do with the power of Python in their palette.</p>
<p>One last amazing thing was how many people were hiring, I don&#8217;t think there wasn&#8217;t an exhibitor who didn&#8217;t open the conversation with &#8220;how far along are you in your studies,&#8221; even the ones selling services to developers. Apparently there is no recession for Python developers.</p>
<p>All in all, I&#8217;m glad I&#8217;m a pythonaut. I definitely want to thank my advisor <a href="http://www.people.fsu.edu/~gerlebacher" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.people.fsu.edu']);"> Gordon Erlebacher</a> for sending us to represent <a href="http://facebook.com/fsuscicomp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://facebook.com']);">DSC</a>!</p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
									<span class="cat-links">
						<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="../../category/code/index.html" title="View all posts in code" rel="category tag">code</a>, <a href="../../category/community/index.html" title="View all posts in community" rel="category tag">community</a>, <a href="../../category/python/index.html" title="View all posts in python" rel="category tag">python</a>, <a href="../../category/travel/index.html" title="View all posts in travel" rel="category tag">travel</a>					</span>
					<span class="meta-sep">|</span>
												<span class="comments-link"><span>Comments Off</span></span>
							</div><!-- .entry-utility -->
		</div><!-- #post-## -->

		
	


			<div id="post-473" class="post-473 post type-post status-publish format-standard hentry category-code category-python">
			<h2 class="entry-title"><a href="../../2011/03/09/a-python-function-timing-decorator/index.html" title="Permalink to A Python Function Timing Decorator" rel="bookmark">A Python Function Timing Decorator</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on</span> <a href="../../2011/03/09/a-python-function-timing-decorator/index.html" title="2:17 pm" rel="bookmark"><span class="entry-date">March 9, 2011</span></a> <span class="meta-sep">by</span> <span class="author vcard"><a class="url fn n" href="../../author/admin/index.html" title="View all posts by enj">enj</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p>I recently went up to North Carolina to visit a good <a href="http://mumrah.posterous.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://mumrah.posterous.com']);">friend</a> of mine, and we got to talking Python as we are wont to do. He told me about a PEP for <a href="http://www.python.org/dev/peps/pep-0380/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.python.org']);">enhancing generator syntax</a> and creating <a href="http://www.python.org/dev/peps/pep-3152/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.python.org']);">cofunctions</a>. To get ready for these we needed to practice using <a href="http://www.dabeaz.com/coroutines/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.dabeaz.com']);">coroutines</a>. I went about this by enhancing my function timing decorator and making it into a class so I could collect and analyze timings on many different functions. Check out the gist, hopefully it will not make you think me a fool, I will discuss my thoughts on it below the code and remove all doubt.</p>
<p><script src="https://gist.github.com/858398.js"> </script></p>
<p>I personally can&#8217;t get over how cool decorators are&#8230; but I digress. The key part is in the <span class="simple_code">__collector</span> function on line 11 where we collect data anytime a decorated function is called. So our dictionary of function names and timing information is being generated rather than simply populated. This allows us to lump together any special processing we want to do during the collection of a timing, such as adding to the count of timings or keeping a running total.<br />
So this is cool because we can create a coroutine which is like building a generator, but cofunctions are cool because they allow you to essentially &#8220;go both ways,&#8221; meaning you can have a generator that generates values, but also receives values from another generator. Once you have this two way yielding communication you can do sweet stuff like a <a href="http://www.cosc.canterbury.ac.nz/greg.ewing/python/yield-from/cd_current/Examples/Scheduler/scheduler.py" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.cosc.canterbury.ac.nz']);">scheduler</a>, which excites me because OpenCL is designed with an <a href="http://en.wikipedia.org/wiki/Event-driven_programming" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://en.wikipedia.org']);">event driven</a> interface, meaning one could setup a really slick OpenCL accelerated workflow using cofunctions with <a href="http://mathema.tician.de/software/pyopencl" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://mathema.tician.de']);">PyOpenCL</a>.</p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
									<span class="cat-links">
						<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="../../category/code/index.html" title="View all posts in code" rel="category tag">code</a>, <a href="../../category/python/index.html" title="View all posts in python" rel="category tag">python</a>					</span>
					<span class="meta-sep">|</span>
												<span class="comments-link"><a href="../../2011/03/09/a-python-function-timing-decorator/index.html#comments" title="Comment on A Python Function Timing Decorator">2 Comments</a></span>
							</div><!-- .entry-utility -->
		</div><!-- #post-## -->

		
	


			<div id="post-441" class="post-441 post type-post status-publish format-standard hentry category-blender category-code">
			<h2 class="entry-title"><a href="../../2011/03/01/hijacking-the-bge-for-fun-and-particles/index.html" title="Permalink to Hijacking the BGE for Fun and Particles" rel="bookmark">Hijacking the BGE for Fun and Particles</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on</span> <a href="../../2011/03/01/hijacking-the-bge-for-fun-and-particles/index.html" title="6:24 pm" rel="bookmark"><span class="entry-date">March 1, 2011</span></a> <span class="meta-sep">by</span> <span class="author vcard"><a class="url fn n" href="../../author/admin/index.html" title="View all posts by enj">enj</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p>Hello world! Care to take a journey into the annals of my twisted mind? Join me on a ride through a small part of the <a href="http://www.blender.org/education-help/tutorials/game-engine/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.blender.org']);">Blender Game Engine</a> on a rickety roller coaster of code and commentary. For those interested in modifying the BGE source I hope this experience will give you ideas, and my personal aspiration is that those more knowledgable than myself will suggest ways of improving what I&#8217;ve done here. You must be at least proficient with C++ to ride this ride.</p>
<p>The ride I am talking about is the modifications I&#8217;ve made to the Blender Game Engine to add a <a href="../../2010/12/16/particles-in-bge-fluids-in-real-time-with-opencl/index.html" >real-time fluid simulation</a> as part of my <a href="../../2011/02/10/particles-in-bge-fluid-surface-and-collision-in-the-works/index.html" >Master&#8217;s research</a>. Right now the code is seperated into two repositories:</p>
<ul>
<li><a href="https://github.com/enjalot/BGERTPS" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">BGERTPS</a> ([B]lender [G]ame [E]ngine &#8211; [R]eal [T]ime [P]article [S]ystem)</li>
<li><a href="https://github.com/enjalot/EnjaParticles" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">EnjaParticles</a> (the standalone library containing the OpenCL Fluid Simulator)</li>
</ul>
<p>We will primarily be focusing on the code in BGERTPS, but you will need both if you want to <a href="https://github.com/enjalot/BGERTPS/blob/master/README" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">compile and run the code</a>. If you&#8217;re mind has a built in C++ preprocessor, you may want to quit reading and check the <a href="https://github.com/enjalot/BGERTPS/blob/master/MODIFIED_FILES" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">list of modified files</a> to see the damage I&#8217;ve done for yourself.</p>
<p>So let&#8217;s start with a little visual of the interface before we dig into the code. Here you see the modifier panel of our Domain object which controls parameters for the system. Our fluid will never leave this domain, so make sure it is big enough to hold objects you may want to interact with. The size of our particles relevant to our domain is determined by the maximum number of particles you specify. Of course smaller particles means better simulation resolution, but it also means more computation. For now the user will have to experiment with the capabilities of their machine, but in the future we hope to have guidelines and it would even be possible to automatically suggest particle counts based on available hardware. As a note, due to a limitation in the sorting code we are using right now the maximum number of particles must be a power of 2 (1024, 2048, 4096, 8192, 16384&#8230; le sigh).</p>
<p><a href="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/modifier_ui.png" ><img class="alignleft size-full wp-image-458" title="RTPS Modifier UI" src="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/modifier_ui.png" alt="RTPS Modifier UI" width="600" height="451" /></a></p>
<p>Now let&#8217;s actually add some fluid to the domain by creating a new object within the domain and giving it a few game properties in the Logic Panel.</p>
<p><a href="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/emitter_ui.png" ><img class="alignleft size-full wp-image-461" title="Emitter UI" src="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/emitter_ui.png" alt="Emitter UI" width="600" height="336" /></a></p>
<p>When the game starts the object&#8217;s bounding box will be filled with up to <strong>num</strong> equally spaced particles, if the volume of the bounding box is too small to hold <strong>num</strong> particles, then it will only inject however many particles are necessary to fill the volume. In the game, after the particles have been emitted, the <strong>num</strong> property is set to 0. Therefore if one would like to emit more particles, it is possible to use a Property Actuator to set the <strong>num</strong> property to a number, at which point the game engine will attempt to emit that number of particles and set the property back to 0.</p>
<p>It is also possible to have the particles collide against triangle meshes, so if you want the fluid to interact with an object make sure to switch to Edit mode, select all and hit ctrl-T to turn all the faces to triangles. It is also important to know which way your normals are facing. Once you have those right, it is as simple as adding a collide boolean to your object&#8217;s game properties. At the moment physics of the object are not shared with the fluid, meaning that forces do not transfer between them. We also have not optimized these collisions, so too many triangles (greater than a few hundred on most systems) will start slowing things down a bit.</p>
<p><a href="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/collision_ui.png" ><img class="alignleft size-full wp-image-462" title="Collision UI" src="http://d3a9pqeyre6pa0.cloudfront.net/wp-content/uploads/2011/03/collision_ui.png" alt="Collision UI" width="600" height="554" /></a></p>
<p>There are also example blend files in EnjaParticles in the <a href="https://github.com/enjalot/EnjaParticles/tree/master/blender" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">blender</a> folder, like rtps_dam_demo.blend that could be used as a starting point. So that&#8217;s how you use it, but how do we make it, and are there better ways to do it?</p>
<h2>RTPS API</h2>
<p>Let&#8217;s start with the modifier. I&#8217;m going to skip how I made my RTPS modifier because I&#8217;ve detailed it <a href="../../2010/05/24/blender-creating-a-custom-modifier/index.html" >line by line before</a>. The important thing to start with is what the RTPS class needs for it to work, so let&#8217;s look at the API I use so far. (Everything in the RTPS library is in the rtps namespace)</p>
<p>First is the constructor (in <a href="https://github.com/enjalot/BGERTPS/blob/master/blender/source/gameengine/Converter/BL_ModifierDeformer.cpp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">BL_ModifierDeformer.cpp</a>):</p>
<pre class="brush: cpp; first-line: 411; gutter: true; title: ; notranslate" title="">rtps::RTPSettings settings(sys, rtmd-&gt;num, rtmd-&gt;dt, grid, rtmd-&gt;collision);
(*slot)-&gt;m_pRTPS = new rtps::RTPS(settings);</pre>
<p>So here we create an RTPSettings object, as well as an RTPS object. I&#8217;ll explain the (*slot) business in a bit but for now let&#8217;s just say we are saving a pointer to our RTPS object. So what are the settings?</p>
<ul>
<li>sys: the type of system, for fluids we have rtps::RTPSettings::SPH</li>
<li>rtmd-&gt;num: the maximum number of particles</li>
<li>rtmd-&gt;dt: the time step we use to <a href="http://en.wikipedia.org/wiki/Numerical_ordinary_differential_equations" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://en.wikipedia.org']);">integrate the system</a></li>
<li>grid: the bounding box of our domain</li>
<li>rtmd-&gt;collision: whether or not to perform collision checks</li>
</ul>
<p>The settings object is simply passed to the constructor of the RTPS class which creates the particle system we specify. If we want to add any particles to the system (presumably we do) we can call the following function (also in <a href="https://github.com/enjalot/BGERTPS/blob/master/blender/source/gameengine/Converter/BL_ModifierDeformer.cpp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">BL_ModifierDeformer.cpp</a>)</p>
<pre class="brush: cpp; first-line: 331; gutter: true; title: ; notranslate" title="">rtps-&gt;system-&gt;addBox(nn, min, max, false);</pre>
<p>Here the parameters are as follows:</p>
<ul>
<li>nn: the number of particles to (attempt) to add</li>
<li>min: the &#8220;bottom left&#8221; corner of the bounding box (as a <a href="https://github.com/enjalot/EnjaParticles/blob/master/rtps/rtpslib/structs.h" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">float4</a>)</li>
<li>max: the &#8220;upper right&#8221; corner of the bounding box (also a float4)</li>
<li>false: a boolean specifying whether to scale the values for the simulation</li>
</ul>
<p>Before we go into detail about how we construct and populate our particle systems, there are two quick functions we need to mention, namely:</p>
<pre class="brush: cpp; first-line: 350; gutter: true; title: ; notranslate" title="">(*slot)-&gt;m_pRTPS-&gt;update();</pre>
<p>which does all of the simulation work every frame, and then there is (in <a href="https://github.com/enjalot/BGERTPS/blob/master/blender/source/gameengine/Rasterizer/RAS_OpenGLRasterizer/RAS_ListRasterizer.cpp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">RAS_ListRasterizer.cpp</a>):</p>
<pre class="brush: cpp; first-line: 234; gutter: true; title: ; notranslate" title="">if(ms.m_bRTPS)
    ms.m_pRTPS-&gt;render();</pre>
<p>and</p>
<pre class="brush: cpp; first-line: 269; gutter: true; title: ; notranslate" title="">if(ms.m_bRTPS)
    ms.m_pRTPS-&gt;render();</pre>
<p>which handles all of the OpenGL rendering of our particles (and subsequently bypasses the normal Blender rendering of the domain). One bug here is that if you are in wireframe mode, the particles won&#8217;t render.</p>
<h2>Modifier</h2>
<p>Now lets go back to creating our system and seeing how we keep track of it in the game. Everything comes down to our RTPS modifier, an object with this modifier defines a system and provides a reference to it. We exploit the fact that modifiers have an Update routine which gets called every frame of game play, and we use that to tell our system what to do. So how does our system get attached to an object? Let&#8217;s start with how the modifier gets applied.<br />
This happens in <a href="https://github.com/enjalot/BGERTPS/blob/master/blender/source/gameengine/Converter/BL_BlenderDataConversion.cpp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">KX_BlenderDataConverter.cpp</a> in the <span class="simple_code">gameobject_from_blenderobject</span> function:</p>
<pre class="brush: cpp; first-line: 1751; gutter: true; title: ; notranslate" title="">bool bIsRTPS = BL_ModifierDeformer::HasRTPSDeformer(ob);</pre>
<p>and</p>
<pre class="brush: cpp; first-line: 1756; gutter: true; title: ; notranslate" title="">BL_ModifierDeformer *dcont = new BL_ModifierDeformer((BL_DeformableGameObject *)gameobj,
kxscene-&gt;GetBlenderScene(), ob,	meshobj, bIsRTPS);</pre>
<p>This function is getting called on all the objects in the scene, so we want to make sure our object knows that it is an RTPS by making its ModifierDeformer aware of the fact. The first step is seeing if the current object has our RTPS modifier, with HasRTPSDeformer(obj) which is defined in <a href="https://github.com/enjalot/BGERTPS/blob/master/blender/source/gameengine/Converter/BL_ModifierDeformer.cpp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">BL_ModifierDeformer.cpp</a> on line 147. The boolean value is stored as a member of the ModifierDeformer instance as defined in <a href="https://github.com/enjalot/BGERTPS/blob/master/blender/source/gameengine/Converter/BL_ModifierDeformer.h" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">BL_ModifierDeformer.h</a>:</p>
<pre class="brush: cpp; first-line: 126; gutter: true; title: ; notranslate" title="">bool    m_bIsRTPS; //different from the RAS_MaterialBucket flag but used to set it.</pre>
<p>As you can see from the comment, we will use a similar boolean in <a href="https://github.com/enjalot/BGERTPS/blob/master/blender/source/gameengine/Rasterizer/RAS_MaterialBucket.h" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">RAS_MaterialBucket.h</a> to signify whether or not a RAS_MeshSlot has our system:</p>
<pre class="brush: cpp; first-line: 138; gutter: true; title: ; notranslate" title="">bool    m_bRTPS;
rtps::RTPS*     m_pRTPS;</pre>
<p>The RAS_MeshSlot is where the real action is, these are what the game engine uses to keep track of objects, at least as far as my understanding is concerned for modifiers and rendering. Now that we can keep a pointer to our system in a MeshSlot, we can access it in several places where we need it. Lets start with <a href="https://github.com/enjalot/BGERTPS/blob/master/blender/source/gameengine/Rasterizer/RAS_MaterialBucket.cpp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">RAS_MaterialBucket.cpp</a> which of course has the constructor (line 63) and destructor (line 90) as well as foregoing the application of OpenGL transformations (we manage our own OpenGL stuff inside the library) on line 618.<br />
As we saw earlier the MeshSlot&#8217;s m_bRTPS boolean is used to call the render function in <a href="https://github.com/enjalot/BGERTPS/blob/master/blender/source/gameengine/Rasterizer/RAS_OpenGLRasterizer/RAS_ListRasterizer.cpp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">RAS_ListRasterizer.cpp</a> on lines 234 and 269.</p>
<p>More interestingly, let&#8217;s look at how the boolean and the pointer are set when the modifier is applied in <a href="https://github.com/enjalot/BGERTPS/blob/master/blender/source/gameengine/Converter/BL_ModifierDeformer.cpp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">BL_ModifierDeformer.cpp</a>:</p>
<pre class="brush: cpp; first-line: 381; gutter: true; title: ; notranslate" title="">if(m_bIsRTPS)
{
    (*slot)-&gt;m_bRTPS = true;

    ModifierData* md;
    for (md = (ModifierData*)m_objMesh-&gt;modifiers.first; md; md = (ModifierData*)md-&gt;next)
    {
        if(md-&gt;type &amp; eModifierType_RTPS)
        {
            RTPSModifierData* rtmd = (RTPSModifierData*)md;

            rtps::RTPSettings::SysType sys = (rtps::RTPSettings::SysType)rtmd-&gt;system;

            //get the bounding box of the object for use as domain bounds
            KX_GameObject* gobj = (KX_GameObject*)m_gameobj;
            MT_Point3 bbpts[8];
            gobj-&gt;GetSGNode()-&gt;getAABBox(bbpts);
            MT_Point3 min = bbpts[0];
            MT_Point3 max = bbpts[7];
            using namespace rtps;
            rtps::Domain grid(float4(min.x(), min.y(), min.z(), 0), float4(max.x(), max.y(), max.z(), 0));

            if (sys == rtps::RTPSettings::SPH)
            {
                rtps::RTPSettings settings(sys, rtmd-&gt;num, rtmd-&gt;dt, grid, rtmd-&gt;collision);
                (*slot)-&gt;m_pRTPS = new rtps::RTPS(settings);
            }</pre>
<p>Where <strong>slot</strong> is defined in a for loop over the list of MeshSlots in the lines that precede this excerpt. First we set our boolean flag to true (383), then we loop over the modifier data on our object (it is conceivable that our object could have more than one modifier) until we find the RTPS modifier (388). So we get the modifier data (390) which contains the values input into the UI, starting with what type of system we are making. Then we get the Axis Aligned Bounding Box for our object to construct the <a href="https://github.com/enjalot/EnjaParticles/blob/master/rtps/rtpslib/domain/Domain.h" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">domain</a> for the simulation (395-401). Finally we construct our RTPS object and save the pointer to our slot (406). If you look at the actual code you will see that there are a couple other systems that are possible, one of which my <a href="http://mymese.blogspot.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://mymese.blogspot.com']);">colleague</a> is using to bring superfast boids to the game engine, but I&#8217;ll let her write about them!</p>
<h2>Modifier Update</h2>
<p>So now that we&#8217;ve got a system created, we want to simulate some fluids, preferably every frame. So let&#8217;s turn our attention to the Update function of our modifier, still in <a href="https://github.com/enjalot/BGERTPS/blob/master/blender/source/gameengine/Converter/BL_ModifierDeformer.cpp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">BL_ModifierDeformer.cpp</a> we again loop over the slots and find our system and make sure it&#8217;s pointer is valid</p>
<pre class="brush: cpp; first-line: 254; gutter: true; title: ; notranslate" title=""> if((*slot)-&gt;m_bRTPS &amp;&amp; (*slot)-&gt;m_pRTPS)
{
    rtps::RTPS* rtps = (*slot)-&gt;m_pRTPS;</pre>
<p>Here we make a convenience variable to refer to our system for the rest of the Update. Next we skip a few lines that aren&#8217;t being used right now, and move on to interacting with other objects in the game!</p>
<pre class="brush: cpp; first-line: 282; gutter: true; title: ; notranslate" title="">if(rtps-&gt;settings.system == rtps::RTPSettings::SPH)
{
    CListValue* oblist = kxs-&gt;GetObjectList();
    int num_objects = oblist-&gt;GetCount();</pre>
<p>The first thing we need to do is make sure we are dealing with the right kind of system, other systems might want to interact differently. The real work starts when we get the list of objects from the game engine.<br />
A quick note, if you look in the code you might see timers sprinkled around:</p>
<pre class="brush: cpp; first-line: 290; gutter: true; title: ; notranslate" title="">timers[TI_EMIT]-&gt;start();</pre>
<p>these are defined in the <a href="https://github.com/enjalot/EnjaParticles/blob/master/rtps/rtpslib/timege.h" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">rtps library</a> and this one was setup in the ModifierDeformer <a href="https://github.com/enjalot/BGERTPS/blob/master/blender/source/gameengine/Converter/BL_ModifierDeformer.h" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">constructor</a>.<br />
On the next line you will see a vector of <a href="https://github.com/enjalot/EnjaParticles/blob/master/rtps/rtpslib/structs.h" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">Triangles</a>:</p>
<pre class="brush: cpp; first-line: 288; gutter: true; title: ; notranslate" title="">std::vector triangles;</pre>
<p>which we will use to store all of the triangles from the meshes of objects we wish to collide against.</p>
<p>So lets loop over the objects in the game and check for properties we care about:</p>
<pre class="brush: cpp; first-line: 292; gutter: true; title: ; notranslate" title="">for(int iob = 0; iob &lt; num_objects; iob++)     {         KX_GameObject* gobj = (KX_GameObject*)oblist-&gt;GetValue(iob);
        STR_String name = gobj-&gt;GetName();
        //printf(&quot;obj: %s\n&quot;, name.Ptr());</pre>
<p>So we have our game object <strong>gobj</strong>, and we can print out it&#8217;s name to give us an idea of whats going on (of course this will print out the name for all objects every frame, so you only want to do this while debugging and figuring things out)</p>
<h2>Collisions</h2>
<p>Now let&#8217;s see how we interact with collider objects:</p>
<pre class="brush: cpp; first-line: 300; gutter: true; title: ; notranslate" title="">//Check if object is a collider
bool collider = false;
CBoolValue* boolprop = (CBoolValue*)gobj-&gt;GetProperty(&quot;collider&quot;);
if(boolprop)
{
    //printf(&quot;obj: %s, collider: %d\n&quot;, name.Ptr(), boolprop-&gt;GetBool());
    collider = boolprop-&gt;GetBool();
    if(collider)
    {
        getTriangles(gobj, triangles);
    }
}</pre>
<p>Here we get the boolean value of our <strong>collider</strong> game property, and if it is true we populate the triangles vector with the triangle faces of the game object by calling the <span class="simple_code">getTriangles</span> function:</p>
<pre class="brush: cpp; first-line: 486; gutter: true; title: ; notranslate" title="">int getTriangles(KX_GameObject* gobj, std::vector &amp;triangles)
{
    //get the mesh and the derived mesh so we can get faces/verts
    RAS_MeshObject* meshobj = gobj-&gt;GetMesh(0);
    Mesh* mesh = meshobj-&gt;GetMesh();
    DerivedMesh *dm = CDDM_from_mesh(mesh, NULL);

    //for now we are assuming triangles
    int n_faces = dm-&gt;getNumFaces(dm);
    MFace* face = dm-&gt;getFaceArray(dm);

    MT_Matrix3x3 grot = gobj-&gt;NodeGetWorldOrientation();
    MT_Point3 gp = gobj-&gt;NodeGetWorldPosition();

    Triangle tri;
    MT_Vector3 fv, ftv;

    for(int i = 0; i &lt; n_faces; i++)
    {
        getTriangle(face[i], grot, gp, dm, tri);
        triangles.push_back(tri);
    }
    return triangles.size();
}</pre>
<p>This function loops over all of the faces in the derived mesh and gets the individual Triangle struct for each one. These triangles are in global coordinates (rather than local to the object) which we accomplish by applying the global transformation (rotation and translation) to them in the <span class="simple_code">getTriangle</span> function:</p>
<pre class="brush: cpp; first-line: 515; gutter: true; title: ; notranslate" title="">void getTriangle(MFace&amp; face, MT_Matrix3x3&amp; grot, MT_Point3&amp; gp, DerivedMesh* dm, Triangle&amp; tri)
{
    MT_Vector3 fv, ftv;
    float mv[3];

    dm-&gt;getVertCo(dm, face.v1, mv);
    //rotate and translate by global rotation/translation to get global coords
    fv = MT_Vector3(mv[0], mv[1], mv[2]);
    ftv = grot*fv + gp;
    tri.verts[0] = float4(ftv.x(), ftv.y(), ftv.z(), 1);

    dm-&gt;getVertCo(dm, face.v2, mv);
    fv = MT_Vector3(mv[0], mv[1], mv[2]);
    ftv = grot*fv + gp;
    tri.verts[1] = float4(ftv.x(), ftv.y(), ftv.z(), 1);

    dm-&gt;getVertCo(dm, face.v3, mv);
    fv = MT_Vector3(mv[0], mv[1], mv[2]);
    ftv = grot*fv + gp;
    tri.verts[2] = float4(ftv.x(), ftv.y(), ftv.z(), 1);

    float4 e1 = float4(tri.verts[1].x - tri.verts[0].x, tri.verts[1].y - tri.verts[0].y, tri.verts[1].z - tri.verts[0].z, 0);
    float4 e2 = float4(tri.verts[2].x - tri.verts[0].x, tri.verts[2].y - tri.verts[0].y, tri.verts[2].z - tri.verts[0].z, 0);
    tri.normal = normalize(cross(e1, e2));
}</pre>
<p>Here we simply get the vertex coordinates of the face and transform them with the rotation matrix and translation vector. This is nice and easy because the <a href="https://github.com/enjalot/BGERTPS/tree/master/blender/intern/moto" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">moto</a> library provides operator overloading for doing matrix and vector operations. Finally we compute the normal using normalize and cross functions defined in the RTPS <a href="https://github.com/enjalot/EnjaParticles/blob/master/rtps/rtpslib/structs.cpp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">library</a>.</p>
<p>For the collisions to happen we need to tell our system about it, which we do after we are done with looping over objects and right before the <span class="simple_code">update</span> call:</p>
<pre class="brush: cpp; first-line: 342; gutter: true; title: ; notranslate" title="">if(triangles.size() &gt; 0 &amp;&amp; rtps-&gt;settings.tri_collision)
{
    rtps-&gt;system-&gt;loadTriangles(triangles);
}</pre>
<h2>Emitters</h2>
<p>We jumped ahead a little bit, before we get to the <span class="simple_code">update</span> call and we are done with checking for the <strong>collider</strong> property, we do emitters by checking if an object has a <strong>num</strong> property:</p>
<pre class="brush: cpp; first-line: 314; gutter: true; title: ; notranslate" title="">//Check if object is an emitter
//for now we are just doing boxes
CIntValue* intprop = (CIntValue*)gobj-&gt;GetProperty(&quot;num&quot;);
if(intprop)
{
    //get the number of particles in this emitter
    int num = (int)intprop-&gt;GetInt();
    if (num == 0) { continue;} //out of particles

    int nn = makeEmitter(num, gobj);
    if( nn == 0) {continue;}
}</pre>
<p>After we get the value of <strong>num</strong> we first we make sure we aren&#8217;t trying to emit 0 particles. The <span class="simple_code">makeEmitter</span> function is defined on line 435 but has a bunch of extra dev stuff, with the important part being the following lines:</p>
<pre class="brush: cpp; first-line: 476; gutter: true; title: ; notranslate" title="">nn = num;
CIntValue *numprop = new CIntValue(0);
gobj-&gt;SetProperty(&quot;num&quot;, numprop);
return nn;</pre>
<p>Which simply sets the <strong>num</strong> property to 0 and returns the original value. This is more complicated than it needs to be because the <span class="simple_code">makeEmitter</span> function will add more capabilities in the future such as turning an object into a &#8220;hose&#8221; to spray particles.  This effect can be simulated for now by setting the <strong>num</strong> property to the number of particles you would like to emit over and over again (because every frame that the num property has a value greater than 0, that many particles will be emitted and then it will be set back to 0).<br />
Finally we get the object&#8217;s bounding box in order to call the API function for adding a box of particles to our system.</p>
<pre class="brush: cpp; first-line: 326; gutter: true; title: ; notranslate" title="">    MT_Point3 bbpts[8];
    gobj-&gt;GetSGNode()-&gt;getAABBox(bbpts);
    float4 min = float4(bbpts[0].x(), bbpts[0].y(), bbpts[0].z(), 0);
    float4 max = float4(bbpts[7].x(), bbpts[7].y(), bbpts[7].z(), 0);
    rtps-&gt;system-&gt;addBox(nn, min, max, false); </pre>
<h2>Conclusion</h2>
<p>Whew, so I&#8217;ve taken you through just about all the changes I&#8217;ve made to the Blender source code. The one thing I haven&#8217;t really touched on is the includes I added in <a href="https://github.com/enjalot/BGERTPS/blob/master/blender/source/gameengine/Converter/BL_ModifierDeformer.cpp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">BL_ModifierDeformer.cpp</a> (lines 59-71) some of which I am hoping for insight on, because it may not be good to include a KX_* header in a BL_* file. Other than that I added <span class="simple_code">#include &#8220;RTPS.h&#8221;</span> or <span class="simple_code">#include &#8220;timege.h&#8221;</span> to some of the various files I&#8217;ve gone over. The MODIFIED_FILES document should cover all the files I&#8217;ve changed, including CMake related changes. I try to keep my git mirror up-to-date with the <a href="http://gitorious.org/blender" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://gitorious.org']);">blender git mirror</a> so one could also use git or svn tools to see my exact changes.</p>
<p>Again, I hope this detailed breakdown will be helpful to someone! I&#8217;d like to thank <a href="http://mogurijin.wordpress.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://mogurijin.wordpress.com']);">Moguri</a>, jbakker and dfelinto from the Blender community for their invaluable help so far. As the material from this post will most likely end up in my Master&#8217;s thesis, I&#8217;d like to shout out to my advisor <a href="http://people.sc.fsu.edu/~gerlebacher/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://people.sc.fsu.edu']);">Gordon Erlebacher</a> my colleague <a href="http://rbfzone.blogspot.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://rbfzone.blogspot.com']);">Evan Bollig</a> (for all kinds of CMake and programming help) and the <a href="http://www.facebook.com/FSUSciComp" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.facebook.com']);">Department of Scientific Computing</a>!</p>
<p>If you made it this far, we got love for the same thing, so holler when you see me on IRC (enjalot) or gtalk :D</p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
									<span class="cat-links">
						<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="../../category/blender/index.html" title="View all posts in blender" rel="category tag">blender</a>, <a href="../../category/code/index.html" title="View all posts in code" rel="category tag">code</a>					</span>
					<span class="meta-sep">|</span>
												<span class="comments-link"><a href="../../2011/03/01/hijacking-the-bge-for-fun-and-particles/index.html#comments" title="Comment on Hijacking the BGE for Fun and Particles">2 Comments</a></span>
							</div><!-- .entry-utility -->
		</div><!-- #post-## -->

		
	


			<div id="post-424" class="post-424 post type-post status-publish format-standard hentry category-advcl category-opencl category-tutorial">
			<h2 class="entry-title"><a href="../../2011/02/22/adventures-in-pyopencl-part-1-getting-started-with-python/index.html" title="Permalink to Adventures in PyOpenCL: Part 1 Getting Started with Python" rel="bookmark">Adventures in PyOpenCL: Part 1 Getting Started with Python</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on</span> <a href="../../2011/02/22/adventures-in-pyopencl-part-1-getting-started-with-python/index.html" title="10:08 pm" rel="bookmark"><span class="entry-date">February 22, 2011</span></a> <span class="meta-sep">by</span> <span class="author vcard"><a class="url fn n" href="../../author/admin/index.html" title="View all posts by enj">enj</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p>Hello, World! I&#8217;m a big fan of Python (and excited to be attending <a href="http://us.pycon.org/2011/home/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://us.pycon.org']);">PyCon</a>!), and I&#8217;ve recently started playing with a great module called <a href="http://mathema.tician.de/software/pyopencl" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://mathema.tician.de']);">PyOpenCL</a>. I&#8217;ve ported my <a href="../../2010/07/13/adventures-in-opencl-part-1-getting-started/index.html" >Part 1</a> (and <a href="../../2010/07/20/adventures-in-opencl-part-1-5-cpp-bindings/index.html" >Part 1.5</a>) tutorials from C (and C++) to Python using PyOpenCL and things are way simpler as you will see shortly :)</p>
<p>This code runs on my Macbook Pro with a NVIDIA 9600GT as well as on our Dell systems running Ubuntu, one with an ATI FirePro v7800 and one with an NVIDIA GTX480. We are working on getting a Windows machine running a decent GPU in our lab, but any feedback from Windows users would be appreciated!</p>
<h3>Let&#8217;s Get Started!</h3>
<p>You will need to have:</p>
<ul>
<li><a href="http://numpy.scipy.org/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://numpy.scipy.org']);">numpy</a> (<a href="http://matplotlib.sourceforge.net/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://matplotlib.sourceforge.net']);">matplotlib</a> and <a href="http://www.scipy.org/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.scipy.org']);">scipy</a> aren&#8217;t a bad idea either). For <a href="http://stronginference.com/scipy-superpack/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://stronginference.com']);">Mac users</a>.</li>
<li><a href="http://wiki.tiker.net/PyOpenCL/Installation" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://wiki.tiker.net']);">PyOpenCL</a>, <a href="http://documen.tician.de/pyopencl/index.html" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://documen.tician.de']);">Documentation</a></li>
<li>if you want GL interop: <a href="http://pyopengl.sourceforge.net/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://pyopengl.sourceforge.net']);">PyOpenGL</a> (used in the Part 2 tutorial coming soon)
<ul>
<li>Mac users will need to <a href="http://wiki.tiker.net/PyOpenCL/Installation/Mac#Optional:_OpenGL_Interop" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://wiki.tiker.net']);">build PyOpenCL from source</a></li>
</ul>
</li>
<li><a href="https://github.com/enjalot/adventures_in_opencl/tree/master/python/part1" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">The code!</a></li>
<li>The OpenCL specifcation and other resources from the <a href="http://www.khronos.org/registry/cl/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.khronos.org']);">Khronos registry</a></li>
</ul>
<p>For this tutorial we only have two files! If you look in your advcl folder</p>
<pre>python/part1</pre>
<p>you will see only two files: <a href="https://github.com/enjalot/adventures_in_opencl/blob/master/python/part1/main.py" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">main.py</a> and <a href="https://github.com/enjalot/adventures_in_opencl/blob/master/python/part1/part1.cl" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">part1.cl</a>, already lookin&#8217; a lot better than C/C++</p>
<p>So let&#8217;s give it a shot, just run</p>
<pre>python main.py</pre>
<p>and you should see</p>
<pre>a [ 0.  1.  2.  3.  4.  5.  6.  7.  8.  9.]
b [ 0.  1.  2.  3.  4.  5.  6.  7.  8.  9.]
c [  0.   2.   4.   6.   8.  10.  12.  14.  16.  18.]</pre>
<p>Yay we&#8217;ve just added two tiny arrays with PyOpenCL, let&#8217;s see how.<br />
First we will look at the OpenCL kernel: <a href="https://github.com/enjalot/adventures_in_opencl/blob/master/python/part1/part1.cl" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">part1.cl</a> (exactly the same code as <a href="https://github.com/enjalot/adventures_in_opencl/tree/master/part1" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">Part 1</a> and<a href="https://github.com/enjalot/adventures_in_opencl/tree/master/part1.5" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);"> Part 1.5</a>)</p>
<pre class="brush: cpp; title: ; notranslate" title="">
__kernel void part1(__global float* a, __global float* b, __global float* c)
{
    unsigned int i = get_global_id(0);
    c[i] = a[i] + b[i];
}</pre>
<p>The kernel is the work that is done by each of the workers in OpenCL. In a GPU these workers are called threads, they are executed in batches called workgroups. So we want to make what would normally be a for loop parallel, so we need to split it up into little pieces of work that can be done at the same time. In this case it is pretty straight forward, we simply make each element of the arrays one piece of data, and make one worker for each of the elements in the output array. OpenCL will then do this bit of work (adding two numbers) with each worker. The way we get it to access and store the right pieces of data is by using the index of the worker (<span class="simple_code">get_global_id</span>) as the index for the data in the arrays.</p>
<p>In order for OpenCL to do the work, we need to give it the data and tell it to execute. Lets take a look at how we do that in <a href="https://github.com/enjalot/adventures_in_opencl/blob/master/python/part1/main.py" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://github.com']);">main.py</a></p>
<p>You can see we&#8217;ve defined a class, CL which will hold all of our OpenCL related variables. I split the setup and execution into four functions like in my last tutorial:</p>
<pre class="brush: python; title: ; notranslate" title="">
example = CL()
example.loadProgram(&quot;part1.cl&quot;)
example.popCorn()
example.execute()
</pre>
<p>First we construct the class, which sets up our OpenCL <a href="http://documen.tician.de/pyopencl/runtime.html#platforms-devices-and-contexts" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://documen.tician.de']);">context</a> as well as the <a href="http://documen.tician.de/pyopencl/runtime.html#command-queues-and-events" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://documen.tician.de']);">command queue</a>.</p>
<pre class="brush: python; title: ; notranslate" title="">self.ctx = cl.create_some_context()
self.queue = cl.CommandQueue(self.ctx)</pre>
<p>Right now we are using convenient PyOpenCL abstractions which will work well for getting started. In my next tutorial I will go over what to do here for OpenGL context sharing, and in the future we can talk about using multiple devices.</p>
<p>Next we load our program in from a file, with all the ease and grace of Python</p>
<pre class="brush: python; title: ; notranslate" title="">f = open(filename, 'r')
fstr = &quot;&quot;.join(f.readlines())
self.program = cl.Program(self.ctx, fstr).build()</pre>
<p>Notice how we call the <span class="simple_code">build()</span> function on the program object and then store it as a variable. This is what we will use to execute our kernel</p>
<p>But first we need to prepare the data we want to work on, so we turn to the trusty NumPy module</p>
<pre class="brush: python; title: ; notranslate" title="">self.a = numpy.array(range(10), dtype=numpy.float32)
self.b = numpy.array(range(10), dtype=numpy.float32)</pre>
<p>We&#8217;ve just initialized two numpy arrays with values from 0 to 9, of course you are going to want to setup your arrays with real data, just make sure that you convert it to numpy arrays with the correct data type before you are ready for OpenCL.</p>
<pre class="brush: python; title: ; notranslate" title="">mf = cl.mem_flags
self.a_buf = cl.Buffer(self.ctx, mf.READ_ONLY | mf.COPY_HOST_PTR, hostbuf=self.a)
self.b_buf = cl.Buffer(self.ctx, mf.READ_ONLY | mf.COPY_HOST_PTR, hostbuf=self.b)
self.dest_buf = cl.Buffer(self.ctx, mf.WRITE_ONLY, self.b.nbytes)</pre>
<p>Here we create two OpenCL Buffers where we pass in data to be copied to the device right away. We also create a &#8220;destination&#8221; buffer which we will use to store the results of our computation. For more information on mem_flags see this <a href="http://www.khronos.org/message_boards/viewtopic.php?f=28&amp;t=3025" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.khronos.org']);">forum post</a>.</p>
<p>These buffers are now ready to be used by the kernel, so lets see how we execute it:</p>
<pre class="brush: python; title: ; notranslate" title="">self.program.part1(self.queue, self.a.shape, None, self.a_buf, self.b_buf, self.dest_buf)</pre>
<p>This is one of the sweet things about python, a method has been added to our program instance with the name of our kernel! So now we call it just like any other function, passing in our command queue, the global and local worksizes (in this case our global size is the size of our arrays, and we don&#8217;t specify a local worksize, leaving it up to the implementation). We then pass in the three parameters to our kernel, the three OpenCL Buffers we created.</p>
<p>Finally we want to look at the results of our computation so we need to read back the data from <span class="simple_code">dest_buf</span> and print it out:</p>
<pre class="brush: python; title: ; notranslate" title="">c = numpy.empty_like(self.a)
cl.enqueue_read_buffer(self.queue, self.dest_buf, c).wait()
print &quot;a&quot;, self.a
print &quot;b&quot;, self.b
print &quot;c&quot;, c</pre>
<p>We read data from the destination buffer into our c array which is an empy numpy array of the correct size and type. Notice the <span class="simple_code">wait()</span> on the end of <span class="simple_code">enqueue_read_buffer</span>, we could have also put <span class="simple_code">self.queue.finish()</span> on the next line instead, to make sure OpenCL was done copying the data before we tried to print it out.</p>
<p>So there we go! As you can see the code is much simpler than in C/C++ and if you are doing most of your work on the GPU, there won&#8217;t be a significant difference in performance between Python and the other languages. The ease of writing in Python has me very excited about prototyping other OpenCL programs with PyOpenCL, and I hope others enjoy it as well!</p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
									<span class="cat-links">
						<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="../../category/tutorial/advcl/index.html" title="View all posts in advcl" rel="category tag">advcl</a>, <a href="../../category/opencl/index.html" title="View all posts in opencl" rel="category tag">opencl</a>, <a href="../../category/tutorial/index.html" title="View all posts in tutorial" rel="category tag">tutorial</a>					</span>
					<span class="meta-sep">|</span>
												<span class="comments-link"><a href="../../2011/02/22/adventures-in-pyopencl-part-1-getting-started-with-python/index.html#comments" title="Comment on Adventures in PyOpenCL: Part 1 Getting Started with Python">14 Comments</a></span>
							</div><!-- .entry-utility -->
		</div><!-- #post-## -->

		
	

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="../3/index.html" ><span class="meta-nav">&larr;</span> Older posts</a></div>
					<div class="nav-next"><a href="../../index.html" >Newer posts <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->
			</div><!-- #content -->
		</div><!-- #container -->


		<div id="primary" class="widget-area" role="complementary">
			<ul class="xoxo">

<li id="search-3" class="widget-container widget_search"><form role="search" method="get" id="searchform" action="../../index.html" >
	<div><label class="screen-reader-text" for="s">Search for:</label>
	<input type="text" value="" name="s" id="s" />
	<input type="submit" id="searchsubmit" value="Search" />
	</div>
	</form></li><li id="nav_menu-3" class="widget-container widget_nav_menu"><div class="menu-navigation-container"><ul id="menu-navigation-1" class="menu"><li class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item menu-item-home menu-item-319"><a href="../../index.html" >Home</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-318"><a href="../../about/index.html" >About</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-694"><a href="../../d3/index.html" >d3</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-316"><a href="../../blender/index.html" >Blender</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-315"><a href="../../opencl/index.html" >OpenCL</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-317"><a href="../../side-projects/index.html" >Side Projects</a></li>
</ul></div></li><li id="text-4" class="widget-container widget_text">			<div class="textwidget"><a href="https://twitter.com/#!/enjalot" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://twitter.com']);"><img src="https://s2.googleusercontent.com/s2/favicons?alt=p&domain=twitter.com"> @enjalot</a>
<br/>
<a href="https://plus.google.com/112153365286725889851/posts" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://plus.google.com']);"><img src="https://s2.googleusercontent.com/s2/favicons?alt=p&domain=plus.google.com"> +Ian Johnson</a></div>
		</li><li id="categories-414549122" class="widget-container widget_categories"><h3 class="widget-title">Categories</h3>		<ul>
	<li class="cat-item cat-item-25"><a href="../../category/tutorial/advcl/index.html" title="Adventures in OpenCL">advcl</a>
</li>
	<li class="cat-item cat-item-32"><a href="../../category/tutorial/advd3-tutorial/index.html" title="View all posts filed under advd3">advd3</a>
</li>
	<li class="cat-item cat-item-23"><a href="../../category/android/index.html" title="View all posts filed under android">android</a>
</li>
	<li class="cat-item cat-item-20"><a href="../../category/blender/index.html" title="View all posts filed under blender">blender</a>
</li>
	<li class="cat-item cat-item-3"><a href="../../category/code/index.html" title="View all posts filed under code">code</a>
</li>
	<li class="cat-item cat-item-4"><a href="../../category/community/index.html" title="View all posts filed under community">community</a>
</li>
	<li class="cat-item cat-item-5"><a href="../../category/culture/index.html" title="View all posts filed under culture">culture</a>
</li>
	<li class="cat-item cat-item-33"><a href="../../category/d3/index.html" title="View all posts filed under d3">d3</a>
</li>
	<li class="cat-item cat-item-6"><a href="../../category/life/index.html" title="View all posts filed under life">life</a>
</li>
	<li class="cat-item cat-item-28"><a href="../../category/math/index.html" title="View all posts filed under math">math</a>
</li>
	<li class="cat-item cat-item-7"><a href="../../category/misc/index.html" title="View all posts filed under misc">misc</a>
</li>
	<li class="cat-item cat-item-8"><a href="../../category/music/index.html" title="View all posts filed under music">music</a>
</li>
	<li class="cat-item cat-item-9"><a href="../../category/news/index.html" title="View all posts filed under news">news</a>
</li>
	<li class="cat-item cat-item-21"><a href="../../category/opencl/index.html" title="View all posts filed under opencl">opencl</a>
</li>
	<li class="cat-item cat-item-30"><a href="../../category/processingjs/index.html" title="View all posts filed under processingjs">processingjs</a>
</li>
	<li class="cat-item cat-item-29"><a href="../../category/python/index.html" title="View all posts filed under python">python</a>
</li>
	<li class="cat-item cat-item-10"><a href="../../category/race/index.html" title="View all posts filed under race">race</a>
</li>
	<li class="cat-item cat-item-11"><a href="../../category/school/index.html" title="View all posts filed under school">school</a>
</li>
	<li class="cat-item cat-item-12"><a href="../../category/tech/index.html" title="View all posts filed under tech">tech</a>
</li>
	<li class="cat-item cat-item-13"><a href="../../category/travel/index.html" title="View all posts filed under travel">travel</a>
</li>
	<li class="cat-item cat-item-24"><a href="../../category/tutorial/index.html" title="View all posts filed under tutorial">tutorial</a>
</li>
	<li class="cat-item cat-item-1"><a href="../../category/uncategorized/index.html" title="View all posts filed under Uncategorized">Uncategorized</a>
</li>
	<li class="cat-item cat-item-14"><a href="../../category/wtf/index.html" title="View all posts filed under wtf">wtf</a>
</li>
	<li class="cat-item cat-item-15"><a href="../../category/中%2596%2587/index.html" title="View all posts filed under 中文">中文</a>
</li>
		</ul>
</li>			</ul>
		</div><!-- #primary .widget-area -->

	</div><!-- #main -->

	<div id="footer" role="contentinfo">
		<div id="colophon">



			<div id="site-info">
				<a href="../../index.html" title="enj" rel="home">
					enj				</a>
			</div><!-- #site-info -->

			<div id="site-generator">
								<a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">Proudly powered by WordPress.</a>
			</div><!-- #site-generator -->

		</div><!-- #colophon -->
	</div><!-- #footer -->

</div><!-- #wrapper -->

<script type='text/javascript' src='http://d3a9pqeyre6pa0.cloudfront.net/wp-includes/js/jquery/jquery.js?ver=1.7.1'></script>
<script type='text/javascript' src='http://s.gravatar.com/js/gprofiles.js?aa&#038;ver=3.3.2'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/jetpack/modules/wpgroho.js%3Fver=3.3.2'></script>
	<div style="display:none">
	</div>
<script type='text/javascript' src='../../wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js%3Fver=3.0.83c'></script>
<script type='text/javascript' src='../../wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPython.js%3Fver=3.0.83c'></script>
<script type='text/javascript' src='../../wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCpp.js%3Fver=3.0.83c'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://enja.org/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83c";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://enja.org/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83c";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
	SyntaxHighlighter.defaults['pad-line-numbers'] = true;
	SyntaxHighlighter.all();
</script>
<script type='text/javascript' src='http://platform.twitter.com/widgets.js?ver=3.3.2'></script>
<script type='text/javascript' src='http://apis.google.com/js/plusone.js?ver=3.3.2'></script>

	<script src="http://stats.wordpress.com/e-201219.js" type="text/javascript"></script>
	<script type="text/javascript">
	st_go({v:'ext',j:'1:1.3',blog:'4037422',post:'0'});
	var load_cmc = function(){linktracker_init(4037422,0,2);};
	if ( typeof addLoadEvent != 'undefined' ) addLoadEvent(load_cmc);
	else load_cmc();
	</script></body>
</html>

<!-- Performance optimized by W3 Total Cache. Learn more: http://www.w3-edge.com/wordpress-plugins/

Minified using disk: basic
Page Caching using disk: basic
Database Caching using disk: basic
Object Caching 2349/2566 objects using disk: basic
Content Delivery Network via Amazon Web Services: CloudFront: d3a9pqeyre6pa0.cloudfront.net

Served from: enja.org @ 2012-05-13 17:39:07 -->